<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Beyond RAG: How to Effectively Analyze an Excel File Using an LLM | Cdani's Blog</title><meta name=keywords content="ai,data,analysis,excel,langchain"><meta name=description content="Abstract As AI developers, we&rsquo;re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, it falls short when dealing with structured data. The RAG approach is so powerful that users or even early stage AI developers may fall in the illusion that it can be applied to any kind of data, including structured data like Excel files."><meta name=author content="Me"><link rel=canonical href=https://c-daniele.github.io/en/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3598bbf45621a4ad34d093926efeb15d6df27175e085d2f069483f14ad39d7fa.css integrity="sha256-NZi79FYhpK000JOSbv6xXW3ycXXghdLwaUg/FK051/o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=it href=https://c-daniele.github.io/it/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/><link rel=alternate hreflang=en href=https://c-daniele.github.io/en/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,theme:"default",securityLevel:"loose"})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NZQZ3Z1RN"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NZQZ3Z1RN",{anonymize_ip:!1})}</script><meta property="og:title" content="Beyond RAG: How to Effectively Analyze an Excel File Using an LLM"><meta property="og:description" content="Abstract As AI developers, we&rsquo;re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, it falls short when dealing with structured data. The RAG approach is so powerful that users or even early stage AI developers may fall in the illusion that it can be applied to any kind of data, including structured data like Excel files."><meta property="og:type" content="article"><meta property="og:url" content="https://c-daniele.github.io/en/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/"><meta property="og:image" content="https://c-daniele.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-05T00:00:00+02:00"><meta property="article:modified_time" content="2025-07-05T00:00:00+02:00"><meta property="og:site_name" content="Cdani's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://c-daniele.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Beyond RAG: How to Effectively Analyze an Excel File Using an LLM"><meta name=twitter:description content="Abstract As AI developers, we&rsquo;re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, it falls short when dealing with structured data. The RAG approach is so powerful that users or even early stage AI developers may fall in the illusion that it can be applied to any kind of data, including structured data like Excel files."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"Beyond RAG: How to Effectively Analyze an Excel File Using an LLM","item":"https://c-daniele.github.io/en/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Beyond RAG: How to Effectively Analyze an Excel File Using an LLM","name":"Beyond RAG: How to Effectively Analyze an Excel File Using an LLM","description":"Abstract As AI developers, we\u0026rsquo;re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, it falls short when dealing with structured data. The RAG approach is so powerful that users or even early stage AI developers may fall in the illusion that it can be applied to any kind of data, including structured data like Excel files.","keywords":["ai","data","analysis","excel","langchain"],"articleBody":"Abstract As AI developers, we’re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, it falls short when dealing with structured data. The RAG approach is so powerful that users or even early stage AI developers may fall in the illusion that it can be applied to any kind of data, including structured data like Excel files. However, this is a misconception that can lead to frustration and inefficiency. One of most ubiquitous kind of file asset across all organization is the Excel file format, which could also be considered as structured or “semi-structured” at least. Anyone who has tryed to process an Excel file using the standard Rag approach, quickly realized there is no real value with processing excel files the same way as PDFs.\nIn this post, I’ll share how I built a system that combines some prompting techniques to create a powerful Excel analysis tool based on SQL.\nAll the code is available on GitHub\nWhy RAG Doesn’t Work with Excel Files RAG has been designed for enrich the LLM prompt with unstructured text from a large corpus of documents. To identify meaningful text chunks, semantic similarity it’s used and here’s why it struggles with Excel data:\n1. The RAG Architecture RAG Architecture is designed for unstructured text, where semantic similarity is key, but Excel data requires exact matches, aggregations, and complex relationships that semantic search simply can’t provide. RAG treats everything as flat text, missing essential contextual clues like column headers, data types, and relationships The chunking process in RAG breaks down the inherent structure of Excel files, leading to loss of critical information. 2. The nature of data in Excel files Excel files are inherently structured or semi-structured, with rows and columns that define relationships between data points. Most likely, the user’s intent is not to extract information in a “narrative” way, but rather to perform calculations, aggregations, and statistical analyses. In structured data, column headers, data types, and relationships between tables are critical. RAG treats everything as flat text, missing these essential contextual clues. The Solution: LLM-Powered Excel-to-SQL Pipeline LLMs capabilities are growing rapidly and today one of the most proficient area is code generation, especially when it comes to SQL queries. So, instead of trying to force RAG into a structured data world, I’ve built a system that embraces the structured nature of Excel files and uses LLMs to convert the excel data into a SQL database schema. This allows us to leverage the power of SQL for querying and analyzing the data.\nHere’s the architecture:\ngraph TD; A[Excel File Upload] --\u003e B[LLM Metadata Analysis]; B --\u003e C[Column Type Detection]; C --\u003e D[SQL Schema Generation]; D --\u003e E[Data Insertion]; E --\u003e F[Ready for Queries]; G[Natural Language Query] --\u003e H[LLM SQL Generation]; H --\u003e I[Query Execution]; I --\u003e J[Results \u0026 Visualization]; F --\u003e H; style A fill:#e1f5fe; style F fill:#e8f5e8; style J fill:#fff3e0; As for the DB, I used SQLite for simplicity, but this architecture can be adapted to any SQL database. As for the LLM, I used OpenAI’s gpt-4.1-mini, but you can use any comparable LLM.\nSystem Components The pipeline consists of four main components:\n1. Metadata Analyzer Uses an LLM to analyze sheet names and column headers, inferring the purpose and structure of the data:\nmetadata_prompt = PromptTemplate( input_variables=[\"sheet_name\", \"columns\"], partial_variables={ \"format_instructions\": metadata_parser.get_format_instructions() }, template=\"\"\" Analyze the following metadata of an Excel sheet: Sheet name: {sheet_name} Columns: {columns} Based on the column names, please return the following information: - suggested_table_name - description of the table content - primary_key_column_name_if_present - category (e.g., financial, sales, inventory, etc.) {format_instructions} Use table names in snake_case and in English. \"\"\" ) 2. Type Detection Engine Combines LLM analysis with statistical sampling to determine the correct SQL data types:\ngraph LR A[Sample Data] --\u003e B[LLM Analysis] A --\u003e C[Statistical Analysis] B --\u003e D[Final Type Decision] C --\u003e D D --\u003e E[SQL Schema] At the end of this process, the system generates a SQL schema that accurately represents the data types and relationships in the Excel file and executes it to create the table in the database.\n3. SQL Generator Converts natural language questions into SQL queries using the database schema as context:\nsql_prompt = PromptTemplate( input_variables=[\"question\", \"schema\", \"sample_data\"], template=\"\"\" Generate an SQL query to answer the following question: Question: {question} Database schema: {schema} Sample data: {sample_data} Generate ONLY the SQL query without any additional explanations. Use standard SQLite syntax. \"\"\" ) 4. Query Executor Executes the generated SQL and formats results for presentation.\nReal-World Example: ETF Portfolio Analysis Let me walk you through a concrete example using an XTrackers ETF holdings composition as example file. The Excel file is pretty simple and contains the breakdown of the “Xtrackers MSCI World ex USA UCITS” ETF, with related underlying stocks, their weight in the portfolio, and sector classification.\nInput Excel File Structure ID Name ISIN Country Currency Exchange Type of Security Rating Industry Classification Weighting 1 SAP DE0007164600 Germany EUR XETRA Equity - Information Technology 1.47% 2 ASML HOLDING NV NL0010273215 Netherlands EUR Euronext Amsterdam Equity Baa2 Information Technology 1.46% 3 NESTLE SA CH0038863350 Switzerland CHF Scoach Switzerland Equity Aa2 Consumer Staples 1.22% 4 NOVARTIS AG CH0012005267 Switzerland CHF Scoach Switzerland Equity Aa3 Health Care 1.08% 5 ROCHE HOLDING PAR AG CH0012032048 Switzerland CHF Scoach Switzerland Equity A1 Health Care 1.06% 6 … ….. …. … … …… .. …. …% System Processing Steps Metadata Analysis\nLLM identifies the dataset as portfolio holdings data Suggests table name: securities_list Identifies ID as primary key candidate Type Detection\nID: NUMBER (sequence number) Name: TEXT (Company Name) ISIN: TEXT (Security Identifier) Country: TEXT (Country of origin) Currency: TEXT (Currency of the security) Exchange: TEXT (Trading exchange) Type of Security: TEXT (e.g., Equity, Bond) Rating: TEXT (Credit rating) Industry Classification: TEXT (Sector classification) Weighting: REAL (Percentage weight in the portfolio) SQL Schema Generation Automatically generated DDL for the table:\nCREATE TABLE securities_list ( id INTEGER NOT NULL, name TEXT NOT NULL, isin TEXT NOT NULL, country TEXT, currency TEXT NOT NULL, exchange TEXT, type_of_security TEXT NOT NULL, rating TEXT, industry_classification TEXT, weighting REAL ); Data Insertion Here, the LLM generates automatically the SQL INSERT statements to populate the table with data from the Excel file: Handles format conversion (B for billions, % for percentages) Validates data integrity Inserts all holdings records Query Examples Once processed, users can ask natural language questions:\nLet’s start with a straightforward question:\nQuery: “How many rows are there in total?” Generated SQL SELECT COUNT(*) as N FROM securities_list; Output N 796 Ok, now le’ts see a more complex query that requires aggregation and understanding of the data structure:\nQuery: “Can you show me the weight of the portfolio for each Country and Sector?” Generated SQL SELECT country, industry_classification AS sector, SUM(weighting) AS total_weight FROM securities_list GROUP BY country, industry_classification; Output country industry_classification total_weight - unknown 0.00349444 Australia Communication Services 0.00139149 Australia Consumer Discretionary 0.00439915 Australia Consumer Staples 0.00200737 Australia Energy 0.00214571 Australia Financials 0.0250382 Australia Health Care 0.00195356 Australia Industrials 0.00295084 Australia Information Technology 0.000675708 …. …. …. Now, let’s take it a step further and apply some where conditions:\nQuery: “Show me the top 5 Non-European holdings by weight” Generated SQL SELECT name, country, weighting FROM securities_list WHERE country NOT IN ('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Iceland', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Norway', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden', 'Switzerland', 'United Kingdom') ORDER BY weighting DESC LIMIT 5; Output name Country weighting COMMONWEALTH BANK OF AUSTRALIA Australia 0.00917773 ROYAL BANK OF CANADA Canada 0.00869856 TOYOTA MOTOR CORP Japan 0.00762924 MITSUBISHI UFJ FINANCIAL GROUP INC Japan 0.00730266 SONY GROUP CORP Japan 0.00721053 Really not bad!\nResults I haven’t performed an exhaustive analysis, but I did run several spot checks and the results were almost always accurate. Even though I developed this system in just a few hours, it has proven to be highly effective and accurate:\nProcessed all rows in the excel in the first run Correctly identified and converted data types Generated accurate SQL for complex queries Provided instant answers to portfolio analysis questions Implementation Highlights Smart Type Detection The system uses a two-stage approach:\nLLM Analysis: Understands context and business meaning Statistical Validation: Confirms patterns in actual data Robust Data Conversion Handles common Excel formatting issues:\nCurrency symbols and abbreviations (K, M, B) Percentage formatting Date variations Empty cells and data validation Context-Aware SQL Generation Within the prompt, the LLM receives:\nComplete database schema Sample data for context Column relationships Previous successful queries (for learning) Limitations While this approach is powerful, it has some limitations:\nEffectiveness: it’s highly dependent on the quality of the excel file. The example file used in this post is a pretty standard “table-like” excel file, but it’s common to have complicated structures, like pivot tables, merged cells, or complex formulas that may not be easily interpretable. So to get the best results, the excel file should be cleaned up before processing. LLM Limitations: The LLM’s ability to understand complex queries is still evolving. It may struggle with highly technical or domain-specific questions. Performance: For very large Excel files, the initial analysis and SQL generation may take time. However, once the schema is established, queries are fast. Data Integrity: The system assumes the Excel data is clean and well-structured. If the data contains errors or inconsistencies, it may lead to incorrect SQL generation or results. Conclusions and Future Evolution This approach solves the fundamental mismatch between RAG and structured data by:\nPreserving data relationships and structure Enabling complex analytical queries Providing exact, calculated results Maintaining data integrity and types Potential Enhancements 1. Multi-Table Relationships To handle more complex Excel files with multiple sheets and table relationships, the system could be extended to manage relationships between multiple tables. For example, if the Excel file contains one sheet with holdings and another with sector mapping, the system could automatically generate the necessary JOINs to analyze the data more complexly.\ngraph TD A[Holdings Table] --\u003e C[JOIN Operations] B[Sector Mapping] --\u003e C C --\u003e D[Complex Analytics] 2. Advanced Analytics Integration Statistical functions (correlation, regression) Time series analysis for historical data Machine learning model integration 3. Visualization Pipeline # Future enhancement: Auto-generate charts def generate_visualization(query_result, question): # Analyze result structure # Choose appropriate chart type # Generate visualization code pass 4. Multi-Format Support Google Sheets integration CSV batch processing Database export compatibility 5. Query Optimization Query caching and reuse Index suggestions Performance monitoring Business Applications This system opens up numerous use cases:\nFinancial Analysis: Portfolio composition, risk assessment Sales Analytics: Performance tracking, trend analysis Inventory Management: Stock levels, demand forecasting HR Analytics: Workforce composition, performance metrics Marketing Analytics: Campaign performance, customer segmentation The key insight is that structured data needs structured solutions. By combining the natural language understanding of LLMs with the precise capabilities of SQL, we can create powerful tools that make complex data analysis accessible to everyone.\n","wordCount":"1831","inLanguage":"en","datePublished":"2025-07-05T00:00:00+02:00","dateModified":"2025-07-05T00:00:00+02:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://c-daniele.github.io/en/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/"},"publisher":{"@type":"Organization","name":"Cdani's Blog","logo":{"@type":"ImageObject","url":"https://c-daniele.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://c-daniele.github.io/en/ accesskey=h title="Home (Alt + H)"><img src=https://c-daniele.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://c-daniele.github.io/it/ title=Italiano aria-label=Italiano>It</a></li></ul></div></div><ul id=menu><li><a href=https://c-daniele.github.io/en/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://c-daniele.github.io/en/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://c-daniele.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://c-daniele.github.io/en/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://c-daniele.github.io/en/>Home</a></div><h1 class=post-title>Beyond RAG: How to Effectively Analyze an Excel File Using an LLM</h1><div class=post-meta><span title='2025-07-05 00:00:00 +0200 +0200'>July 5, 2025</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1831 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://c-daniele.github.io/it/posts/2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms/>It</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1-the-rag-architecture>1. <strong>The RAG Architecture</strong></a></li><li><a href=#2-the-nature-of-data-in-excel-files>2. <strong>The nature of data in Excel files</strong></a></li></ul><ul><li><a href=#system-components>System Components</a><ul><li><a href=#1-metadata-analyzer>1. <strong>Metadata Analyzer</strong></a></li><li><a href=#2-type-detection-engine>2. <strong>Type Detection Engine</strong></a></li><li><a href=#3-sql-generator>3. <strong>SQL Generator</strong></a></li><li><a href=#4-query-executor>4. <strong>Query Executor</strong></a></li></ul></li></ul><ul><li><a href=#input-excel-file-structure>Input Excel File Structure</a></li><li><a href=#system-processing-steps>System Processing Steps</a></li><li><a href=#query-examples>Query Examples</a><ul><li></li></ul></li><li><a href=#results>Results</a></li></ul><ul><li><a href=#smart-type-detection>Smart Type Detection</a></li><li><a href=#robust-data-conversion>Robust Data Conversion</a></li><li><a href=#context-aware-sql-generation>Context-Aware SQL Generation</a></li></ul><ul><li><a href=#potential-enhancements>Potential Enhancements</a><ul><li><a href=#1-multi-table-relationships>1. <strong>Multi-Table Relationships</strong></a></li><li><a href=#2-advanced-analytics-integration>2. <strong>Advanced Analytics Integration</strong></a></li><li><a href=#3-visualization-pipeline>3. <strong>Visualization Pipeline</strong></a></li><li><a href=#4-multi-format-support>4. <strong>Multi-Format Support</strong></a></li><li><a href=#5-query-optimization>5. <strong>Query Optimization</strong></a></li></ul></li><li><a href=#business-applications>Business Applications</a></li></ul></nav></div></details></div><div class=post-content><h1 id=abstract>Abstract<a hidden class=anchor aria-hidden=true href=#abstract>#</a></h1><p>As AI developers, we&rsquo;re always looking for ways to make data more accessible and queryable through natural language. While Retrieval-Augmented Generation (RAG) has revolutionized how we interact with unstructired textual documents, <strong>it falls short when dealing with structured data</strong>.
The RAG approach is so powerful that users or even early stage AI developers may fall in <strong>the illusion that it can be applied to any kind of data</strong>, including structured data like Excel files. However, this is a misconception that can lead to frustration and inefficiency.
One of most ubiquitous kind of file asset across all organization is the Excel file format, which could also be considered as structured or &ldquo;semi-structured&rdquo; at least.
Anyone who has tryed to process an Excel file using the standard Rag approach, quickly realized there is no real value with processing excel files the same way as PDFs.</p><p>In this post, I&rsquo;ll share how I built a system that combines some prompting techniques to create a powerful Excel analysis tool based on SQL.</p><p>All the code is available on <a href=https://github.com/c-daniele/llm-excel-analysis>GitHub</a></p><h1 id=why-rag-doesnt-work-with-excel-files>Why RAG Doesn&rsquo;t Work with Excel Files<a hidden class=anchor aria-hidden=true href=#why-rag-doesnt-work-with-excel-files>#</a></h1><p>RAG has been designed for enrich the LLM prompt with unstructured text from a large corpus of documents. To identify meaningful text chunks, semantic similarity it&rsquo;s used and here&rsquo;s why it struggles with Excel data:</p><h2 id=1-the-rag-architecture>1. <strong>The RAG Architecture</strong><a hidden class=anchor aria-hidden=true href=#1-the-rag-architecture>#</a></h2><ul><li><strong>RAG Architecture is designed for unstructured text</strong>, where <em>semantic similarity</em> is key, but Excel data requires exact matches, aggregations, and complex relationships that semantic search simply can&rsquo;t provide.</li><li>RAG treats everything as flat text, missing essential contextual clues like column headers, data types, and relationships</li><li><strong>The chunking process in RAG breaks down the inherent structure</strong> of Excel files, leading to loss of critical information.</li></ul><h2 id=2-the-nature-of-data-in-excel-files>2. <strong>The nature of data in Excel files</strong><a hidden class=anchor aria-hidden=true href=#2-the-nature-of-data-in-excel-files>#</a></h2><ul><li>Excel files are inherently structured or semi-structured, with rows and columns that define relationships between data points.</li><li>Most likely, the user&rsquo;s intent is not to extract information in a &ldquo;narrative&rdquo; way, but rather to perform <strong>calculations, aggregations, and statistical analyses</strong>.</li><li>In structured data, column headers, data types, and relationships between tables are critical. RAG treats everything as flat text, missing these essential contextual clues.</li></ul><h1 id=the-solution-llm-powered-excel-to-sql-pipeline>The Solution: LLM-Powered Excel-to-SQL Pipeline<a hidden class=anchor aria-hidden=true href=#the-solution-llm-powered-excel-to-sql-pipeline>#</a></h1><p>LLMs capabilities are growing rapidly and today one of the most proficient area is <strong>code generation</strong>, especially when it comes to SQL queries.
So, instead of trying to force RAG into a structured data world, I&rsquo;ve built a system that embraces the structured nature of Excel files and uses LLMs to <strong>convert</strong> the excel data <strong>into a SQL database</strong> schema. This allows us to leverage the power of SQL for querying and analyzing the data.</p><p>Here&rsquo;s the architecture:</p><div class=mermaid>graph TD;
A[Excel File Upload] --> B[LLM Metadata Analysis];
B --> C[Column Type Detection];
C --> D[SQL Schema Generation];
D --> E[Data Insertion];
E --> F[Ready for Queries];
G[Natural Language Query] --> H[LLM SQL Generation];
H --> I[Query Execution];
I --> J[Results & Visualization];
F --> H;
style A fill:#e1f5fe;
style F fill:#e8f5e8;
style J fill:#fff3e0;</div><p>As for the DB, I used SQLite for simplicity, but this architecture can be adapted to any SQL database.
As for the LLM, I used OpenAI&rsquo;s gpt-4.1-mini, but you can use any comparable LLM.</p><h2 id=system-components>System Components<a hidden class=anchor aria-hidden=true href=#system-components>#</a></h2><p>The pipeline consists of four main components:</p><h3 id=1-metadata-analyzer>1. <strong>Metadata Analyzer</strong><a hidden class=anchor aria-hidden=true href=#1-metadata-analyzer>#</a></h3><p>Uses an LLM to analyze sheet names and column headers, inferring the purpose and structure of the data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>metadata_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;sheet_name&#34;</span><span class=p>,</span> <span class=s2>&#34;columns&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>partial_variables</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format_instructions&#34;</span><span class=p>:</span> <span class=n>metadata_parser</span><span class=o>.</span><span class=n>get_format_instructions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>template</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Analyze the following metadata of an Excel sheet:
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Sheet name: </span><span class=si>{sheet_name}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Columns: </span><span class=si>{columns}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Based on the column names, please return the following information:
</span></span></span><span class=line><span class=cl><span class=s2>        - suggested_table_name
</span></span></span><span class=line><span class=cl><span class=s2>        - description of the table content
</span></span></span><span class=line><span class=cl><span class=s2>        - primary_key_column_name_if_present
</span></span></span><span class=line><span class=cl><span class=s2>        - category (e.g., financial, sales, inventory, etc.)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{format_instructions}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Use table names in snake_case and in English.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=2-type-detection-engine>2. <strong>Type Detection Engine</strong><a hidden class=anchor aria-hidden=true href=#2-type-detection-engine>#</a></h3><p>Combines LLM analysis with statistical sampling to determine the correct SQL data types:</p><div class=mermaid>graph LR
A[Sample Data] --> B[LLM Analysis]
A --> C[Statistical Analysis]
B --> D[Final Type Decision]
C --> D
D --> E[SQL Schema]</div><p>At the end of this process, the system generates a SQL schema that accurately represents the data types and relationships in the Excel file and executes it to create the table in the database.</p><h3 id=3-sql-generator>3. <strong>SQL Generator</strong><a hidden class=anchor aria-hidden=true href=#3-sql-generator>#</a></h3><p>Converts natural language questions into SQL queries using the database schema as context:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sql_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>,</span> <span class=s2>&#34;schema&#34;</span><span class=p>,</span> <span class=s2>&#34;sample_data&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>template</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Generate an SQL query to answer the following question:
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Question: </span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Database schema:
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{schema}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Sample data:
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{sample_data}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Generate ONLY the SQL query without any additional explanations.
</span></span></span><span class=line><span class=cl><span class=s2>    Use standard SQLite syntax.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=4-query-executor>4. <strong>Query Executor</strong><a hidden class=anchor aria-hidden=true href=#4-query-executor>#</a></h3><p>Executes the generated SQL and formats results for presentation.</p><h1 id=real-world-example-etf-portfolio-analysis>Real-World Example: ETF Portfolio Analysis<a hidden class=anchor aria-hidden=true href=#real-world-example-etf-portfolio-analysis>#</a></h1><p>Let me walk you through a concrete example using an XTrackers ETF holdings composition as example file.
The Excel file is pretty simple and contains the breakdown of the &ldquo;Xtrackers MSCI World ex USA UCITS&rdquo; ETF, with related underlying stocks, their weight in the portfolio, and sector classification.</p><h2 id=input-excel-file-structure>Input Excel File Structure<a hidden class=anchor aria-hidden=true href=#input-excel-file-structure>#</a></h2><table><thead><tr><th>ID</th><th>Name</th><th>ISIN</th><th>Country</th><th>Currency</th><th>Exchange</th><th>Type of Security</th><th>Rating</th><th>Industry Classification</th><th>Weighting</th></tr></thead><tbody><tr><td>1</td><td>SAP</td><td>DE0007164600</td><td>Germany</td><td>EUR</td><td>XETRA</td><td>Equity</td><td>-</td><td>Information Technology</td><td>1.47%</td></tr><tr><td>2</td><td>ASML HOLDING NV</td><td>NL0010273215</td><td>Netherlands</td><td>EUR</td><td>Euronext Amsterdam</td><td>Equity</td><td>Baa2</td><td>Information Technology</td><td>1.46%</td></tr><tr><td>3</td><td>NESTLE SA</td><td>CH0038863350</td><td>Switzerland</td><td>CHF</td><td>Scoach Switzerland</td><td>Equity</td><td>Aa2</td><td>Consumer Staples</td><td>1.22%</td></tr><tr><td>4</td><td>NOVARTIS AG</td><td>CH0012005267</td><td>Switzerland</td><td>CHF</td><td>Scoach Switzerland</td><td>Equity</td><td>Aa3</td><td>Health Care</td><td>1.08%</td></tr><tr><td>5</td><td>ROCHE HOLDING PAR AG</td><td>CH0012032048</td><td>Switzerland</td><td>CHF</td><td>Scoach Switzerland</td><td>Equity</td><td>A1</td><td>Health Care</td><td>1.06%</td></tr><tr><td>6</td><td>&mldr;</td><td>&mldr;..</td><td>&mldr;.</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;&mldr;</td><td>..</td><td>&mldr;.</td><td>&mldr;%</td></tr></tbody></table><h2 id=system-processing-steps>System Processing Steps<a hidden class=anchor aria-hidden=true href=#system-processing-steps>#</a></h2><ol><li><p><strong>Metadata Analysis</strong></p><ul><li>LLM identifies the dataset as portfolio holdings data</li><li>Suggests table name: <code>securities_list</code></li><li>Identifies <code>ID</code> as primary key candidate</li></ul></li><li><p><strong>Type Detection</strong></p><ul><li><code>ID</code>: NUMBER (sequence number)</li><li><code>Name</code>: TEXT (Company Name)</li><li><code>ISIN</code>: TEXT (Security Identifier)</li><li><code>Country</code>: TEXT (Country of origin)</li><li><code>Currency</code>: TEXT (Currency of the security)</li><li><code>Exchange</code>: TEXT (Trading exchange)</li><li><code>Type of Security</code>: TEXT (e.g., Equity, Bond)</li><li><code>Rating</code>: TEXT (Credit rating)</li><li><code>Industry Classification</code>: TEXT (Sector classification)</li><li><code>Weighting</code>: REAL (Percentage weight in the portfolio)</li></ul></li><li><p><strong>SQL Schema Generation</strong>
Automatically generated DDL for the table:</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>   </span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>securities_list</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>isin</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>country</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>currency</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>exchange</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>type_of_security</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rating</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>industry_classification</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>weighting</span><span class=w> </span><span class=nb>REAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><ol><li><strong>Data Insertion</strong>
Here, the LLM generates automatically the SQL INSERT statements to populate the table with data from the Excel file:<ul><li>Handles format conversion (B for billions, % for percentages)</li><li>Validates data integrity</li><li>Inserts all holdings records</li></ul></li></ol><h2 id=query-examples>Query Examples<a hidden class=anchor aria-hidden=true href=#query-examples>#</a></h2><p>Once processed, users can ask natural language questions:</p><p>Let&rsquo;s start with a straightforward question:</p><hr><h4 id=query-how-many-rows-are-there-in-total><strong>Query</strong>: &ldquo;<em>How many rows are there in total?</em>&rdquo;<a hidden class=anchor aria-hidden=true href=#query-how-many-rows-are-there-in-total>#</a></h4><h4 id=generated-sql><strong>Generated SQL</strong><a hidden class=anchor aria-hidden=true href=#generated-sql>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>securities_list</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=output><strong>Output</strong><a hidden class=anchor aria-hidden=true href=#output>#</a></h4><table><thead><tr><th style=text-align:right>N</th></tr></thead><tbody><tr><td style=text-align:right>796</td></tr></tbody></table><hr><p>Ok, now le&rsquo;ts see a more complex query that requires aggregation and understanding of the data structure:</p><h4 id=query-can-you-show-me-the-weight-of-the-portfolio-for-each-country-and-sector><strong>Query</strong>: &ldquo;<em>Can you show me the weight of the portfolio for each Country and Sector?</em>&rdquo;<a hidden class=anchor aria-hidden=true href=#query-can-you-show-me-the-weight-of-the-portfolio-for-each-country-and-sector>#</a></h4><h4 id=generated-sql-1><strong>Generated SQL</strong><a hidden class=anchor aria-hidden=true href=#generated-sql-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry_classification</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>sector</span><span class=p>,</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>weighting</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_weight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>securities_list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry_classification</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=output-1><strong>Output</strong><a hidden class=anchor aria-hidden=true href=#output-1>#</a></h4><table><thead><tr><th style=text-align:left>country</th><th style=text-align:left>industry_classification</th><th style=text-align:right>total_weight</th></tr></thead><tbody><tr><td style=text-align:left>-</td><td style=text-align:left>unknown</td><td style=text-align:right>0.00349444</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Communication Services</td><td style=text-align:right>0.00139149</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Consumer Discretionary</td><td style=text-align:right>0.00439915</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Consumer Staples</td><td style=text-align:right>0.00200737</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Energy</td><td style=text-align:right>0.00214571</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Financials</td><td style=text-align:right>0.0250382</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Health Care</td><td style=text-align:right>0.00195356</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Industrials</td><td style=text-align:right>0.00295084</td></tr><tr><td style=text-align:left>Australia</td><td style=text-align:left>Information Technology</td><td style=text-align:right>0.000675708</td></tr><tr><td style=text-align:left>&mldr;.</td><td style=text-align:left>&mldr;.</td><td style=text-align:right>&mldr;.</td></tr></tbody></table><hr><p>Now, let&rsquo;s take it a step further and apply some where conditions:</p><h4 id=query-show-me-the-top-5-non-european-holdings-by-weight><strong>Query</strong>: &ldquo;<em>Show me the top 5 Non-European holdings by weight</em>&rdquo;<a hidden class=anchor aria-hidden=true href=#query-show-me-the-top-5-non-european-holdings-by-weight>#</a></h4><h4 id=generated-sql-2><strong>Generated SQL</strong><a hidden class=anchor aria-hidden=true href=#generated-sql-2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>weighting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>securities_list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Austria&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Belgium&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bulgaria&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Croatia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Cyprus&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Czech Republic&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Denmark&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Estonia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Finland&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;France&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Germany&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Greece&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Hungary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Iceland&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Ireland&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Italy&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Latvia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Lithuania&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Luxembourg&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Malta&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Netherlands&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Norway&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Poland&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Portugal&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Romania&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Slovakia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Slovenia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Spain&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Sweden&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Switzerland&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;United Kingdom&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>weighting</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=output-2><strong>Output</strong><a hidden class=anchor aria-hidden=true href=#output-2>#</a></h4><table><thead><tr><th style=text-align:left>name</th><th style=text-align:left>Country</th><th style=text-align:right>weighting</th></tr></thead><tbody><tr><td style=text-align:left>COMMONWEALTH BANK OF AUSTRALIA</td><td style=text-align:left>Australia</td><td style=text-align:right>0.00917773</td></tr><tr><td style=text-align:left>ROYAL BANK OF CANADA</td><td style=text-align:left>Canada</td><td style=text-align:right>0.00869856</td></tr><tr><td style=text-align:left>TOYOTA MOTOR CORP</td><td style=text-align:left>Japan</td><td style=text-align:right>0.00762924</td></tr><tr><td style=text-align:left>MITSUBISHI UFJ FINANCIAL GROUP INC</td><td style=text-align:left>Japan</td><td style=text-align:right>0.00730266</td></tr><tr><td style=text-align:left>SONY GROUP CORP</td><td style=text-align:left>Japan</td><td style=text-align:right>0.00721053</td></tr></tbody></table><hr><p>Really not bad!</p><h2 id=results>Results<a hidden class=anchor aria-hidden=true href=#results>#</a></h2><p>I haven&rsquo;t performed an exhaustive analysis, but I did run several spot checks and the results were almost always accurate.
Even though I developed this system in just a few hours, it has proven to be highly effective and accurate:</p><ul><li>Processed all rows in the excel in the first run</li><li>Correctly identified and converted data types</li><li>Generated accurate SQL for complex queries</li><li>Provided instant answers to portfolio analysis questions</li></ul><h1 id=implementation-highlights>Implementation Highlights<a hidden class=anchor aria-hidden=true href=#implementation-highlights>#</a></h1><h2 id=smart-type-detection>Smart Type Detection<a hidden class=anchor aria-hidden=true href=#smart-type-detection>#</a></h2><p>The system uses a two-stage approach:</p><ol><li><strong>LLM Analysis</strong>: Understands context and business meaning</li><li><strong>Statistical Validation</strong>: Confirms patterns in actual data</li></ol><h2 id=robust-data-conversion>Robust Data Conversion<a hidden class=anchor aria-hidden=true href=#robust-data-conversion>#</a></h2><p>Handles common Excel formatting issues:</p><ul><li>Currency symbols and abbreviations (K, M, B)</li><li>Percentage formatting</li><li>Date variations</li><li>Empty cells and data validation</li></ul><h2 id=context-aware-sql-generation>Context-Aware SQL Generation<a hidden class=anchor aria-hidden=true href=#context-aware-sql-generation>#</a></h2><p>Within the prompt, the LLM receives:</p><ul><li>Complete database schema</li><li>Sample data for context</li><li>Column relationships</li><li>Previous successful queries (for learning)</li></ul><h1 id=limitations>Limitations<a hidden class=anchor aria-hidden=true href=#limitations>#</a></h1><p>While this approach is powerful, it has some limitations:</p><ul><li><strong>Effectiveness</strong>: it&rsquo;s highly dependent on the quality of the excel file. The example file used in this post is a pretty standard &ldquo;table-like&rdquo; excel file, but it&rsquo;s common to have complicated structures, like pivot tables, merged cells, or complex formulas that may not be easily interpretable. So to get the best results, the excel file should be cleaned up before processing.</li><li><strong>LLM Limitations</strong>: The LLM&rsquo;s ability to understand complex queries is still evolving. It may struggle with highly technical or domain-specific questions.</li><li><strong>Performance</strong>: For very large Excel files, the initial analysis and SQL generation may take time. However, once the schema is established, queries are fast.</li><li><strong>Data Integrity</strong>: The system assumes the Excel data is clean and well-structured. If the data contains errors or inconsistencies, it may lead to incorrect SQL generation or results.</li></ul><h1 id=conclusions-and-future-evolution>Conclusions and Future Evolution<a hidden class=anchor aria-hidden=true href=#conclusions-and-future-evolution>#</a></h1><p>This approach solves the fundamental mismatch between RAG and structured data by:</p><ul><li>Preserving data relationships and structure</li><li>Enabling complex analytical queries</li><li>Providing exact, calculated results</li><li>Maintaining data integrity and types</li></ul><h2 id=potential-enhancements>Potential Enhancements<a hidden class=anchor aria-hidden=true href=#potential-enhancements>#</a></h2><h3 id=1-multi-table-relationships>1. <strong>Multi-Table Relationships</strong><a hidden class=anchor aria-hidden=true href=#1-multi-table-relationships>#</a></h3><p>To handle more complex Excel files with multiple sheets and table relationships, the system could be extended to manage relationships between multiple tables. For example, if the Excel file contains one sheet with holdings and another with sector mapping, the system could automatically generate the necessary JOINs to analyze the data more complexly.</p><div class=mermaid>graph TD
A[Holdings Table] --> C[JOIN Operations]
B[Sector Mapping] --> C
C --> D[Complex Analytics]</div><h3 id=2-advanced-analytics-integration>2. <strong>Advanced Analytics Integration</strong><a hidden class=anchor aria-hidden=true href=#2-advanced-analytics-integration>#</a></h3><ul><li>Statistical functions (correlation, regression)</li><li>Time series analysis for historical data</li><li>Machine learning model integration</li></ul><h3 id=3-visualization-pipeline>3. <strong>Visualization Pipeline</strong><a hidden class=anchor aria-hidden=true href=#3-visualization-pipeline>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Future enhancement: Auto-generate charts</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_visualization</span><span class=p>(</span><span class=n>query_result</span><span class=p>,</span> <span class=n>question</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Analyze result structure</span>
</span></span><span class=line><span class=cl>    <span class=c1># Choose appropriate chart type</span>
</span></span><span class=line><span class=cl>    <span class=c1># Generate visualization code</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span></code></pre></div><h3 id=4-multi-format-support>4. <strong>Multi-Format Support</strong><a hidden class=anchor aria-hidden=true href=#4-multi-format-support>#</a></h3><ul><li>Google Sheets integration</li><li>CSV batch processing</li><li>Database export compatibility</li></ul><h3 id=5-query-optimization>5. <strong>Query Optimization</strong><a hidden class=anchor aria-hidden=true href=#5-query-optimization>#</a></h3><ul><li>Query caching and reuse</li><li>Index suggestions</li><li>Performance monitoring</li></ul><h2 id=business-applications>Business Applications<a hidden class=anchor aria-hidden=true href=#business-applications>#</a></h2><p>This system opens up numerous use cases:</p><ul><li><strong>Financial Analysis</strong>: Portfolio composition, risk assessment</li><li><strong>Sales Analytics</strong>: Performance tracking, trend analysis</li><li><strong>Inventory Management</strong>: Stock levels, demand forecasting</li><li><strong>HR Analytics</strong>: Workforce composition, performance metrics</li><li><strong>Marketing Analytics</strong>: Campaign performance, customer segmentation</li></ul><p>The key insight is that structured data needs structured solutions. By combining the natural language understanding of LLMs with the precise capabilities of SQL, we can create powerful tools that make complex data analysis accessible to everyone.</p><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://c-daniele.github.io/en/tags/ai/>ai</a></li><li><a href=https://c-daniele.github.io/en/tags/data/>data</a></li><li><a href=https://c-daniele.github.io/en/tags/analysis/>analysis</a></li><li><a href=https://c-daniele.github.io/en/tags/excel/>excel</a></li><li><a href=https://c-daniele.github.io/en/tags/langchain/>langchain</a></li></ul><nav class=paginav><a class=next href=https://c-daniele.github.io/en/posts/2025-05-15-policy-puppetry/><span class=title>Next »</span><br><span>Policy Puppetry Prompt Injection</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on twitter" href="https://twitter.com/intent/tweet/?text=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM&amp;url=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f&amp;hashtags=ai%2cdata%2canalysis%2cexcel%2clangchain"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f&amp;title=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM&amp;summary=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM&amp;source=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f&title=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on whatsapp" href="https://api.whatsapp.com/send?text=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM%20-%20https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on telegram" href="https://telegram.me/share/url?text=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM&amp;url=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Beyond RAG: How to Effectively Analyze an Excel File Using an LLM on ycombinator" href="https://news.ycombinator.com/submitlink?t=Beyond%20RAG%3a%20How%20to%20Effectively%20Analyze%20an%20Excel%20File%20Using%20an%20LLM&u=https%3a%2f%2fc-daniele.github.io%2fen%2fposts%2f2025-07-05-advanced-tecnique-for-analyzing-excel-files-with-llms%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://c-daniele.github.io/en/>Cdani's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>